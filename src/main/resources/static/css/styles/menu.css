@GetMapping("/generar-certificado")
public String generarCertificado(Model model, HttpServletResponse response, @AuthenticationPrincipal OidcUser oidcUser) {
    try {
        model.addAttribute("fecha", LocalDate.now());
        Residente residente = residenteService.residenteByCorreo((String) oidcUser.getClaims().get("email"));
        model.addAttribute("user", residente);

        // Obt√©n el motor de plantillas de Thymeleaf
        SpringTemplateEngine templateEngine = new SpringTemplateEngine();
        
        // Lee la plantilla Thymeleaf del archivo HTML
        String htmlTemplate = "certificado";
        ClassLoaderTemplateResolver templateResolver = new ClassLoaderTemplateResolver();
        templateResolver.setTemplateMode(TemplateMode.HTML);
        templateResolver.setSuffix(".html");
        templateEngine.setTemplateResolver(templateResolver);
        
        // Procesa la plantilla con Thymeleaf
        Context thymeleafContext = new Context();
        thymeleafContext.setVariables(model.asMap());
        String processedHtml = templateEngine.process(htmlTemplate, thymeleafContext);

        // Configura ITextRenderer con la plantilla procesada
        ITextRenderer renderer = new ITextRenderer();
        renderer.setDocumentFromString(processedHtml);
        renderer.layout();
        
        // Genera el PDF
        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
        renderer.createPDF(outputStream);

        // Configura la respuesta HTTP
        response.setHeader("Content-Disposition", "attachment; filename=certificado.pdf");
        response.setContentType("application/pdf");
        response.setContentLength(outputStream.size());
        
        // Escribe el PDF en el flujo de salida de la respuesta
        try (ServletOutputStream servletOutputStream = response.getOutputStream()) {
            outputStream.writeTo(servletOutputStream);
            servletOutputStream.flush();
        }
    } catch (IOException | DocumentException e) {
        e.printStackTrace();
        return "error";
    }
    return "certificado";
}
